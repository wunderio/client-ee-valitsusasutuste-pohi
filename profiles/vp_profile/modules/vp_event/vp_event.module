<?php

/**
 * @file
 * Code for the VP Event feature.
 */

include_once 'vp_event.features.inc';

/**
 * Implements hook_theme_registry_alter().
 *
 * Change the location of views-exposed-form--vp-calendar.tpl.php to vp_event
 * module.
 */
function vp_event_theme_registry_alter(&$theme_registry) {
  if (arg(0) === 'calendar') {
    $module_path = drupal_get_path('module', 'vp_event');
    $theme_registry['views_exposed_form__vp_calendar'] = array(
      'template' => 'views-exposed-form--vp-calendar',
      'path' => $module_path . '/templates',
      'render element' => 'form',
      'base hook' => 'views_exposed_form',
      'type' => 'theme_engine',
      // @todo: Needed but not sure what the value should be - active theme or module.
      'theme path' => $module_path,
      'preprocess functions' => array(),
      'process functions' => array(),
    );
  }
}

/**
 * Implements hook_ds_fields_info().
 */
function vp_event_ds_fields_info($entity_type) {
  $fields = array();

  if ($entity_type == 'node') {
    $fields['vp_ct_event_ds_event_type_link'] = array(
      'title' => t('Event type link'),
      'field_type' => DS_FIELD_TYPE_FUNCTION,
      'ui_limit' => array('ct_event|*'),
      'function' => 'vp_ct_event_ds_event_type_link',
    );
    $fields = array($entity_type => $fields);
  }

  return $fields;
}

/**
 * Render function of DS custom field for event tag.
 */
function vp_ct_event_ds_event_type_link($field) {
  $entity = $field['entity'];
  if (isset($entity->field_event_ct_event_type) && !empty($entity->field_event_ct_event_type)) {
    $tid = $entity->field_event_ct_event_type[LANGUAGE_NONE][0]['tid'];
    $term = taxonomy_term_load($tid);
    $translated_term = i18n_taxonomy_localize_terms($term);
    return l($translated_term->name, current_path(), array(
      'query' => array('field_event_ct_event_type_tid' => $tid),
      'attributes' => array(
        'class' => array('tag'),
      ),
    ));
  }
}
